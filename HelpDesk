GO
DROP VIEW AGEING;

GO
CREATE VIEW AGEING AS 
SELECT [CATEGORY],[SUB-CATEGORY],'DEFECT/SR' [TYPE], DATEDIFF(day, [CREATED TIME], '2024-04-30') AS DD,  
		(CASE
        WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30') < 30 THEN '0 - 30 Days'
        WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30')  > 30 
		      AND DATEDIFF(day, [CREATED TIME], '2024-04-30') <= 60 THEN '30 Days - 60 Days' 
		WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30')  > 60 
		      AND DATEDIFF(day, [CREATED TIME], '2024-04-30') <= 90 THEN '60 Days - 90 Days' 
		ELSE '> 90 Days'
		END) AS TI_BAND 
FROM  [dbo].[TICK_TODAY]
WHERE STATUS NOT IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Category] = 'Business Application Related'
AND [Sub-Category] <> ''
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
UNION
SELECT [CATEGORY],[SUB-CATEGORY],'CR' [TYPE], DATEDIFF(day, [CREATED TIME], '2024-04-30') AS DD, 
		(CASE
        WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30') < 30 THEN '0 - 30 Days'
        WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30')  > 30 
		AND DATEDIFF(day, [CREATED TIME], '2024-04-30') <= 60 THEN '30 Days - 60 Days' 
		WHEN DATEDIFF(day, [CREATED TIME], '2024-04-30')  > 60 
		      AND DATEDIFF(day, [CREATED TIME], '2024-04-30') <= 90 THEN '60 Days - 90 Days' 
		ELSE '> 90 Days'
		END) AS CR_BAND 
from [dbo].[CR_TODAY]
WHERE STATUS NOT IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Category] = 'Business Application Related'
AND [Sub-Category] <> ''
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')

GO
DROP VIEW AGEING_P

GO
CREATE VIEW AGEING_P AS
SELECT [SUB-CATEGORY], [TYPE], TI_BAND, 
		COUNT(*) AS CNT  
FROM  [dbo].[AGEING]
GROUP BY [SUB-CATEGORY],TYPE,TI_BAND

GO
DROP VIEW KPI; 

GO
CREATE VIEW KPI AS

-- BF DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE, 'B/F' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [CREATED TIME] < '2024-04-01' 
AND [CATEGORY] = 'Business Application Related'
AND STATUS NOT IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE, 'B/F' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [Created Time] < '2024-04-01'
AND [Closed Time]  >=  '2024-04-01' 
AND  [Closed Time] <='2024-04-30'
AND STATUS IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- NEW DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE, 'NEW' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [Created Time]  >=  '2024-04-01' 
AND [Created Time] <='2024-04-30'
AND [CATEGORY] = 'Business Application Related'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- CLOSED DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'CLOSED' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [CLOSED TIME] >= '2024-04-01' 
AND [CLOSED TIME] <= '2024-04-30'
AND [CATEGORY] = 'Business Application Related'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION 
-- CLOSED DEFECT/SR WITH RESOLVED --
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'CLOSED' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Resolved','RESOLVED')
AND [CATEGORY] = 'Business Application Related'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- KIV DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'KIV' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Pending')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- NOT STARTED DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'NOT STARTED' STATUS , COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [CATEGORY] = 'Business Application Related'
AND [STATUS] IN ('Awaiting Supervisor Approval','Awaiting IT Manager Approval','Awaiting Predecessor Ticket')
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- WIP - REQUIREMENT STUDY DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE, 'REQUIREMENT STUDY' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Pending Vendor Info','Pending Requester Info')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- DEV DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'DEVELOPMENT' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Open','Work In Progress','Development','CR in Progress')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- TEST DEFECT/SR--
SELECT [Ticket Id],[SUB-CATEGORY],'DEFECT/SR' TYPE,'TEST' STATUS, COUNT(*) CNT FROM [dbo].[TICK_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('UAT','TEST')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Ticket Id],[SUB-CATEGORY]
UNION
-- B/F CR ---
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE, 'B/F' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [Created Time] < '2024-04-01'
AND [Closed Time]  >=  '2024-04-01' 
AND  [Closed Time] <= '2024-04-30'
AND STATUS IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE, 'B/F' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [CREATED TIME] < '2024-04-01' 
AND STATUS NOT IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- NEW CR ---
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE, 'NEW' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE  [SUB-CATEGORY] <> ''
AND [CREATED TIME] >= '2024-04-01' 
AND [CREATED TIME] <= '2024-04-30'
AND [CATEGORY] = 'Business Application Related'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- CLOSED CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE,'CLOSED' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Closed','Resolved','CLOSED','RESOLVED')
AND [CLOSED TIME] >='2024-04-01' 
AND [CLOSED TIME] <= '2024-04-30'
AND [CATEGORY] = 'Business Application Related'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- KIV CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE,'KIV' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Awaiting Approval','Awaiting CAC Approval')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- NOT STARTED CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE,'NOT STARTED' STATUS , COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [CATEGORY] = 'Business Application Related'
AND [STATUS] IN ('')
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- WIP - REQUIREMENT STUDY CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE, 'REQUIREMENT STUDY' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Planning','CM Review')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- WIP - DEV CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE,'DEVELOPMENT' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Pending Release')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]
UNION
-- WIP - TEST CR --
SELECT [Change Id],[SUB-CATEGORY],'CR' TYPE,'TEST' STATUS, COUNT(*) CNT FROM [dbo].[CR_TODAY]
WHERE [SUB-CATEGORY] <> ''
AND [STATUS] IN ('Pending Release')
AND [CATEGORY] = 'Business Application Related'
AND [CREATED TIME] <= '2024-04-30'
AND [Agent Name] in ('hakiem.halim MUHAMMAD HAKIEM HALIM','RAHASYIMAH RAHASYIMAH MOHAMAD JAIS',
'AFIFAH AFIFAH MOHD MURTADZA','MOHD KHAIRUL ANNUAR MOHD KHAIRUL ANNUAR MASZALAN')
GROUP BY [Change Id],[SUB-CATEGORY]


--PIVOT FOR AGEING
GO
SELECT * FROM (SELECT [SUB-CATEGORY] 'APPLICATION/SYSTEM', TYPE, TI_BAND, CNT FROM AGEING_P ) 
AS Source
PIVOT ( COUNT(CNT) FOR TI_BAND IN ([0 - 30 Days],[30 Days - 60 Days],[60 Days - 90 Days],[> 90 Days])) 
AS PivotTable ORDER BY [APPLICATION/SYSTEM],TYPE


-- PIVOT FOR KPI
GO 
SELECT * FROM (
    SELECT [Sub-Category] 'APPLICATION/SYSTEM', TYPE, STATUS, CNT FROM KPI ) 
	AS Source    
	PIVOT (SUM(CNT) FOR STATUS IN ([B/F],NEW,KIV,[NOT STARTED],[REQUIREMENT STUDY],DEVELOPMENT,TEST,CLOSED)) 
	AS PivotTable ORDER BY [APPLICATION/SYSTEM],TYPE; 



